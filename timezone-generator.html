<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pablo's Magical Timezone Table Generator (abbrev helper)</title>
<style>
  :root{--bg:#f7f8fb;--card:#fff;--accent:#0b5cff;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:20px;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(15,15,30,0.06);margin-bottom:16px}
  label{display:block;margin:8px 0 6px;font-size:13px;color:#333}
  input,select,textarea,button{font:inherit;padding:8px;border:1px solid #ddd;border-radius:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1 1 180px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border:1px solid #e6e8ef;text-align:left;font-size:13px}
  th{background:#f2f4fa}
  .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  button{cursor:pointer;background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:8px}
  button.secondary{background:#fff;border:1px solid #cfd8ff;color:var(--accent)}
  .small{font-size:12px;color:var(--muted)}
  .zones-edit{width:100%;min-height:90px;white-space:pre-wrap}
  .copy-success{color:green;margin-left:8px}
  .toggles{display:flex;gap:8px;flex-wrap:wrap}
  .preset-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .preset-list button{padding:6px 8px;background:#f3f6ff;border:1px solid #e2e8ff;color:var(--accent);border-radius:6px}
  .abbrev-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .note{font-size:12px;color:#555;margin-top:8px}
  footer{font-size:12px;color:var(--muted);margin-top:12px}
  @media (max-width:700px){ .row{flex-direction:column} }
</style>
</head>
<body>
  <div class="wrap">
    <header><h1>Timezone Table Generator</h1><div class="small">Enter a source time, pick a timezone (or use an abbreviation like "PST"), choose columns & presets, then generate a copy-ready HTML table.</div></header>

    <div class="card">
      <label for="datetime">Date &amp; time (wall-clock in source timezone)</label>
      <div class="row">
        <input id="datetime" type="datetime-local" />
        <select id="sourceTz"></select>
      </div>

      <div class="abbrev-row">
        <label style="margin:0">Abbrev / quick pick</label>
        <select id="abbrevSelect" style="width:220px">
          <option value="">— pick abbreviation —</option>
        </select>
        <input id="abbrevInput" placeholder="Type e.g. PST or EST" style="max-width:160px" />
        <button id="useAbbrev" class="secondary">Use abbrev</button>
        <div id="abbrevMsg" class="small" style="margin-left:6px;color:#a00"></div>
      </div>

      <label>Pick a preset (or edit the list below)</label>
      <div class="preset-list" id="presets"></div>

      <label for="zones">Target locations (friendly label | IANA zone) — one per line</label>
      <textarea id="zones" class="zones-edit" placeholder="London (UK) | Europe/London
New York (US) | America/New_York
Los Angeles (US) | America/Los_Angeles"></textarea>

      <div style="margin-top:8px" class="toggles">
        <label><input type="checkbox" id="colAbbrev" checked /> Include abbrev</label>
        <label><input type="checkbox" id="colOffset" checked /> Include UTC offset</label>
        <label><input type="checkbox" id="colIso" checked /> Include ISO (with seconds)</label>
      </div>

      <div class="controls">
        <button id="generate">Generate HTML Table</button>
        <button id="copy" class="secondary">Copy HTML</button>
        <button id="download" class="secondary">Download .html</button>
        <div id="copied" class="copy-success" style="display:none">Copied ✓</div>
      </div>

      <div id="resultArea" style="margin-top:14px"></div>
    </div>

<script>
/*
  Abbrev helper added.
  ABBREV_MAP contains my chosen mappings (opinionated — I labelled likely/common mappings).
  You can expand/modify ABBREV_MAP as needed.
*/

const ABBREV_MAP = {
  // North American
  "PST": "America/Los_Angeles", "PDT": "America/Los_Angeles",
  "MST": "America/Denver", "MDT": "America/Denver",
  "CST": "America/Chicago", "CDT": "America/Chicago",
  "EST": "America/New_York", "EDT": "America/New_York",
  // Europe
  "GMT": "Etc/GMT", "BST": "Europe/London",
  "CET": "Europe/Berlin", "CEST": "Europe/Berlin",
  // Asia / Oceania
  "IST": "Asia/Kolkata", // ambiguous (India / Ireland) — mapped to India here
  "JST": "Asia/Tokyo",
  "KST": "Asia/Seoul",
  "CST-CHINA": "Asia/Shanghai", // helper if you type CST-CHINA
  "AEST": "Australia/Sydney", "AEDT": "Australia/Sydney",
  // misc
  "UTC": "UTC", "UT": "UTC"
};

const PRESETS = {
  "Common (News)": [
    "Los Angeles (US) | America/Los_Angeles",
    "Chicago (US) | America/Chicago",
    "New York (US) | America/New_York",
    "São Paulo (BR) | America/Sao_Paulo",
    "London (UK) | Europe/London",
    "Paris (FR) | Europe/Paris",
    "Berlin (DE) | Europe/Berlin",
    "Mumbai (IN) | Asia/Kolkata",
    "Tokyo (JP) | Asia/Tokyo",
    "Sydney (AU) | Australia/Sydney",
    "Auckland (NZ) | Pacific/Auckland"
  ],
  "Tech (US-centric)": [
    "San Francisco (US) | America/Los_Angeles",
    "Seattle (US) | America/Los_Angeles",
    "Denver (US) | America/Denver",
    "Austin (US) | America/Chicago",
    "New York (US) | America/New_York",
    "London (UK) | Europe/London",
    "Bangalore (IN) | Asia/Kolkata",
    "Tokyo (JP) | Asia/Tokyo"
  ],
  "All major": [
    "Los Angeles (US) | America/Los_Angeles",
    "Denver (US) | America/Denver",
    "Chicago (US) | America/Chicago",
    "New York (US) | America/New_York",
    "São Paulo (BR) | America/Sao_Paulo",
    "London (UK) | Europe/London",
    "Paris (FR) | Europe/Paris",
    "Berlin (DE) | Europe/Berlin",
    "Moscow (RU) | Europe/Moscow",
    "Mumbai (IN) | Asia/Kolkata",
    "Shanghai (CN) | Asia/Shanghai",
    "Tokyo (JP) | Asia/Tokyo",
    "Sydney (AU) | Australia/Sydney",
    "Auckland (NZ) | Pacific/Auckland"
  ]
};

const tzSelect = document.getElementById('sourceTz');
const dtInput = document.getElementById('datetime');
const zonesTextarea = document.getElementById('zones');
const generateBtn = document.getElementById('generate');
const resultArea = document.getElementById('resultArea');
const copyBtn = document.getElementById('copy');
const copiedEl = document.getElementById('copied');
const downloadBtn = document.getElementById('download');
const colAbbrev = document.getElementById('colAbbrev');
const colOffset = document.getElementById('colOffset');
const colIso = document.getElementById('colIso');
const presetsDiv = document.getElementById('presets');

const abbrevSelect = document.getElementById('abbrevSelect');
const abbrevInput = document.getElementById('abbrevInput');
const useAbbrevBtn = document.getElementById('useAbbrev');
const abbrevMsg = document.getElementById('abbrevMsg');

const popularZones = [
  "UTC","America/Los_Angeles","America/Denver","America/Chicago","America/New_York",
  "America/Sao_Paulo","Europe/London","Europe/Paris","Europe/Berlin","Europe/Moscow",
  "Asia/Kolkata","Asia/Shanghai","Asia/Tokyo","Australia/Sydney","Pacific/Auckland"
];

function populateSourceZones(){
  popularZones.forEach(tz=>{
    const opt = document.createElement('option'); opt.value = tz; opt.textContent = tz; tzSelect.appendChild(opt);
  });
  try{
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    if(tz && !Array.from(tzSelect.options).some(o=>o.value===tz)){
      const o = document.createElement('option'); o.value=tz; o.textContent=tz; tzSelect.insertBefore(o,tzSelect.firstChild);
    }
    tzSelect.value = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  }catch(e){}
}

function buildPresets(){
  for(const k of Object.keys(PRESETS)){
    const btn = document.createElement('button');
    btn.type='button'; btn.textContent=k;
    btn.addEventListener('click', ()=>{ zonesTextarea.value = PRESETS[k].join('\n'); });
    presetsDiv.appendChild(btn);
  }
}

function buildAbbrevOptions(){
  const keys = Object.keys(ABBREV_MAP);
  keys.sort();
  for(const k of keys){
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = `${k} → ${ABBREV_MAP[k]}`;
    abbrevSelect.appendChild(opt);
  }
}

// format helpers
function formatForZone(date, tz, opts){ try { return new Intl.DateTimeFormat(undefined, Object.assign({timeZone: tz}, opts)).format(date);}catch(e){return '—';}}
function tzAbbrev(date, tz){ try { const parts = new Intl.DateTimeFormat('en-US',{timeZone:tz,timeZoneName:'short'}).formatToParts(date); const tzPart = parts.find(p=>p.type==='timeZoneName'); return tzPart?tzPart.value:'';}catch(e){return ''}}
function utcOffsetString(date, tz){
  try{
    const dtF = new Intl.DateTimeFormat('en-US',{timeZone:tz, hour12:false, year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const parts = dtF.formatToParts(date);
    const y = parts.find(p=>p.type==='year').value;
    const mo = parts.find(p=>p.type==='month').value;
    const d = parts.find(p=>p.type==='day').value;
    const hr = parts.find(p=>p.type==='hour').value;
    const min = parts.find(p=>p.type==='minute').value;
    const sec = parts.find(p=>p.type==='second').value;
    const asUtc = Date.UTC(+y, +mo-1, +d, +hr, +min, +sec);
    const diffMinutes = Math.round((asUtc - date.getTime())/60000);
    const offsetMinutes = -diffMinutes;
    const sign = offsetMinutes >= 0 ? '+' : '-';
    const absMin = Math.abs(offsetMinutes);
    const hh = String(Math.floor(absMin/60)).padStart(2,'0');
    const mm = String(absMin%60).padStart(2,'0');
    return `UTC${sign}${hh}:${mm}`;
  }catch(e){ return ''; }
}

function parseLines(text){
  return text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(l=>{
    const parts = l.split('|').map(s=>s.trim());
    if(parts.length===1) return {label:parts[0], tz:parts[0]};
    return {label:parts[0], tz:parts[1]};
  });
}

function parseDateTimeLocalToDate(value, sourceTz){
  const [datePart, timePart] = value.split('T');
  if(!datePart || !timePart) return null;
  const [year,month,day] = datePart.split('-').map(Number);
  const [hour,minute] = timePart.split(':').map(Number);
  let guess = Date.UTC(year, month-1, day, hour, minute, 0);
  let low = guess - 48*3600*1000;
  let high = guess + 48*3600*1000;
  for(let i=0;i<40;i++){
    const mid = Math.floor((low+high)/2);
    const parts = new Intl.DateTimeFormat('en-US',{timeZone:sourceTz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}).formatToParts(new Date(mid));
    const y = +parts.find(p=>p.type==='year').value;
    const mo = +parts.find(p=>p.type==='month').value;
    const d = +parts.find(p=>p.type==='day').value;
    const hr = +parts.find(p=>p.type==='hour').value;
    const mn = +parts.find(p=>p.type==='minute').value;
    if(y===year && mo===month && d===day && hr===hour && mn===minute){
      return new Date(mid);
    }
    const cmpMid = (y*100000000 + mo*1000000 + d*10000 + hr*100 + mn);
    const targetComp = (year*100000000 + month*1000000 + day*10000 + hour*100 + minute);
    if(cmpMid < targetComp) low = mid + 1; else high = mid - 1;
  }
  return new Date(guess);
}

function buildTableHTML(momentDate, sourceTz, targets){
  const includeISO = colIso.checked;
  const includeAbbrev = colAbbrev.checked;
  const includeOffset = colOffset.checked;
  let html = `<table border="1" cellpadding="6" cellspacing="0">\n  <thead>\n    <tr>\n      <th>Location</th>\n      <th>Local date &amp; time</th>\n      ${includeAbbrev?'<th>Timezone</th>':''}\n      ${includeOffset?'<th>UTC offset</th>':''}\n      ${includeISO?'<th>ISO (local)</th>':''}\n    </tr>\n  </thead>\n  <tbody>\n`;
  for(const t of targets){
    try{
      const formatted = formatForZone(momentDate, t.tz, {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      const iso = formatForZone(momentDate, t.tz, {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
      const abbrev = tzAbbrev(momentDate, t.tz) || '';
      const offset = utcOffsetString(momentDate, t.tz) || '';
      html += `    <tr>\n      <td>${escapeHtml(t.label)}</td>\n      <td>${escapeHtml(formatted)}</td>\n      ${includeAbbrev?`<td>${escapeHtml(abbrev)}</td>`:''}\n      ${includeOffset?`<td>${escapeHtml(offset)}</td>`:''}\n      ${includeISO?`<td>${escapeHtml(iso)}</td>`:''}\n    </tr>\n`;
    }catch(e){
      html += `    <tr><td colspan="5">${escapeHtml(t.label)} — invalid timezone: ${escapeHtml(t.tz)}</td></tr>\n`;
    }
  }
  html += '  </tbody>\n</table>';
  return html;
}

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

generateBtn.addEventListener('click', ()=>{
  const dtVal = dtInput.value;
  const sourceTz = tzSelect.value;
  if(!dtVal || !sourceTz){ alert('Please choose a date/time and source timezone.'); return; }
  const targetTargets = parseLines(zonesTextarea.value);
  if(!targetTargets.length){ alert('Please add at least one target.'); return; }
  const momentDate = parseDateTimeLocalToDate(dtVal, sourceTz);
  if(!momentDate){ alert('Could not parse the date/time.'); return; }
  const html = buildTableHTML(momentDate, sourceTz, targetTargets);

  resultArea.innerHTML = '<div class="small">Preview (copy HTML below):</div>' + html + '<div style="margin-top:8px"><strong>Raw HTML:</strong></div>';
  const rawWrapper = document.createElement('div');
  rawWrapper.style.marginTop = '8px';
  const ta = document.createElement('textarea');
  ta.id = 'raw';
  ta.style.width = '100%';
  ta.style.height = '160px';
  ta.value = html;
  rawWrapper.appendChild(ta);
  resultArea.appendChild(rawWrapper);
});

copyBtn.addEventListener('click', async ()=>{
  const raw = document.getElementById('raw');
  if(!raw){ alert('Generate the table first.'); return; }
  try{
    await navigator.clipboard.writeText(raw.value);
    copiedEl.style.display = 'inline';
    setTimeout(()=>copiedEl.style.display='none',2200);
  } catch(e){
    alert('Copy failed — please select the contents of the Raw HTML box and copy manually.');
  }
});

downloadBtn.addEventListener('click', ()=>{
  const raw = document.getElementById('raw');
  if(!raw){ alert('Generate the table first.'); return; }
  const full = `<!doctype html><html><head><meta charset="utf-8"><title>timezone-table</title></head><body>${raw.value}</body></html>`;
  const blob = new Blob([full],{type:'text/html'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download='timezone-table.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// Abbrev button behaviour
function setSourceFromAbbrevInput(abbrev){
  abbrev = String(abbrev||'').trim().toUpperCase();
  abbrevMsg.textContent = '';
  if(!abbrev){ abbrevMsg.textContent = 'Enter an abbreviation (e.g. PST) or pick from dropdown.'; return; }
  // direct map
  if(ABBREV_MAP[abbrev]){
    tzSelect.value = ABBREV_MAP[abbrev];
    abbrevMsg.textContent = `Using ${abbrev} → ${ABBREV_MAP[abbrev]}`;
    return;
  }
  // handle common suffixes like -CHINA
  if(ABBREV_MAP[abbrev + '-CHINA']){
    tzSelect.value = ABBREV_MAP[abbrev + '-CHINA'];
    abbrevMsg.textContent = `Using ${abbrev}-CHINA → ${ABBREV_MAP[abbrev + '-CHINA']}`;
    return;
  }
  // try direct match in tzSelect (allow user to type full IANA accidentally)
  if(Array.from(tzSelect.options).some(o=>o.value.toUpperCase()===abbrev || o.textContent.toUpperCase()===abbrev)){
    const match = Array.from(tzSelect.options).find(o=>o.value.toUpperCase()===abbrev || o.textContent.toUpperCase()===abbrev);
    tzSelect.value = match.value;
    abbrevMsg.textContent = `Using IANA zone ${match.value}`;
    return;
  }
  abbrevMsg.textContent = `Unknown abbrev "${abbrev}". I can add mappings if you want.`;
}

useAbbrevBtn.addEventListener('click', ()=>{
  const a = abbrevInput.value || abbrevSelect.value;
  setSourceFromAbbrevInput(a);
});

abbrevSelect.addEventListener('change', ()=>{
  const a = abbrevSelect.value;
  if(a) { abbrevInput.value = a; abbrevMsg.textContent = ''; }
});

populateSourceZones();
buildPresets();
buildAbbrevOptions();

// set default datetime to now
(function init(){
  const now = new Date();
  function pad(n){return String(n).padStart(2,'0');}
  dtInput.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
  zonesTextarea.value = PRESETS["Common (News)"].join('\n');
  abbrevInput.value = '';
})();
</script>
</body>
</html>
